<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Digital Sign</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: black;
      overflow: hidden;
      height: 100%;
    }
    .section {
      position: absolute;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      display: none;
    }
    .visible {
      display: block;
    }
    video, iframe, img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border: none;
    }
    #sst-img {
      object-fit: contain;
      background: black;
    }
  </style>
</head>
<body>

  <!-- Video Section -->
  <div id="video-section" class="section visible">
    <video id="promoVideo" autoplay muted playsinline>
      <source src="https://raw.githubusercontent.com/skenderes/digital-sign/main/media/IUI_2023_intro_alpha_16x9_24fps.mp4" type="video/mp4">
    </video>
  </div>

  <!-- Google Slides Section -->
  <div id="slides-section" class="section">
    <iframe
      src="https://docs.google.com/presentation/d/e/2PACX-1vTr65TWJAKH-8sEuWBc46E4HrvnnDYGfk5szsxWjxlw_HVRvw7x-9RgKJlKayFzM2woNY3pG0RUoJqU/pub?start=true&loop=true&delayms=5000"
      allowfullscreen
    ></iframe>
  </div>

  <!-- SST Animation Section -->
  <div id="sst-section" class="section">
    <img id="sst-img" src="" alt="SST Animation">
  </div>

  <script>
    const sections = [
      document.getElementById('video-section'),
      document.getElementById('slides-section'),
      document.getElementById('sst-section')
    ];
    const video = document.getElementById('promoVideo');
    const sstImg = document.getElementById('sst-img');

    let currentIndex = 0;
    function showSection(index) {
      sections.forEach((sec, i) => {
        sec.classList.toggle('visible', i === index);
      });
    }

    // Helper: get YYYYMMDD for N days ago in UTC
    function getDateString(daysAgo) {
      const date = new Date();
      date.setUTCDate(date.getUTCDate() - daysAgo);
      const yyyy = date.getUTCFullYear();
      const mm = String(date.getUTCMonth() + 1).padStart(2, '0');
      const dd = String(date.getUTCDate()).padStart(2, '0');
      return `${yyyy}${mm}${dd}`;
    }

    let validSSTFrames = [];
    let sstIndex = 0;
    let sstInterval = null;

    // Preload and validate SST images
    function preloadSSTImages(callback) {
      let checksRemaining = 14; // number of days/frames to try
      validSSTFrames = [];

      for (let i = 0; i < 14; i++) {
        const dateStr = getDateString(i);
        const url = `https://www.ospo.noaa.gov/data/cb/ssta/daily/${dateStr.slice(0,4)}/ct5km_ssta_v3.1_global_${dateStr}.png`;

        const img = new Image();
        img.onload = () => {
          validSSTFrames.push(url);
          if (--checksRemaining === 0) callback();
        };
        img.onerror = () => {
          if (--checksRemaining === 0) callback();
        };
        img.src = url;
      }
    }

    function updateSSTFrame() {
      if (validSSTFrames.length > 0) {
        sstImg.src = validSSTFrames[sstIndex] + `?t=${Date.now()}`;
        sstIndex = (sstIndex + 1) % validSSTFrames.length;
      }
    }

    // Play SST animation fully then call callback
    function startSSTAnimation(callback) {
      sstIndex = 0;
      updateSSTFrame();
      let count = 1;

      sstInterval = setInterval(() => {
        if (count >= validSSTFrames.length) {
          clearInterval(sstInterval);
          callback();
        } else {
          updateSSTFrame();
          count++;
        }
      }, 500); // speed: 500ms per frame
    }

    // Start slides section for fixed duration, then callback
    function startSlidesSection() {
      currentIndex = 1;
      showSection(currentIndex);
      setTimeout(() => {
        startSSTSection();
      }, 15000); // slides duration: 15 sec (adjust if you want)
    }

    function startSSTSection() {
      currentIndex = 2;
      showSection(currentIndex);

      if (validSSTFrames.length > 0) {
        startSSTAnimation(() => {
          startVideoSection();
        });
      } else {
        // No SST frames loaded, skip to video
        startVideoSection();
      }
    }

    function startVideoSection() {
      currentIndex = 0;
      showSection(currentIndex);
      video.currentTime = 0;
      video.play();
    }

    // On video ended, start slideshow
    video.loop = false;
    video.addEventListener('ended', () => {
      startSlidesSection();
    });

    // Preload SST images then start video playback cycle
    preloadSSTImages(() => {
      console.log(`Loaded ${validSSTFrames.length} SST frames`);
      startVideoSection();
    });
  </script>

</body>
</html>
